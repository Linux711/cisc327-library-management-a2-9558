name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Initialize test database
        run: |
          python - <<EOF
import os
from database import get_db_connection

os.environ['DB_FILE'] = 'test_library.db'

conn = get_db_connection()
conn.execute('''
CREATE TABLE IF NOT EXISTS books (
id INTEGER PRIMARY KEY,
title TEXT,
author TEXT,
isbn TEXT UNIQUE,
quantity INTEGER
)
''')
conn.execute('''
CREATE TABLE IF NOT EXISTS borrow_records (
id INTEGER PRIMARY KEY,
patron_id TEXT,
book_id INTEGER,
borrow_date TEXT,
return_date TEXT
)
''')
conn.commit()
conn.close()
EOF

      - name: Run tests
        env:
          DB_FILE: test_library.db
        run: pytest
